name: Manual Rollback

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'The full commit SHA to roll back to'
        required: true

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Rollback to Specific SHA
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/lattice

            # Sync to specific SHA
            git fetch origin
            git reset --hard ${{ github.event.inputs.commit_sha }}

            # Rebuild and restart
            docker compose build
            docker compose up -d --remove-orphans

            # Wait for health check
            echo "Waiting for health check..."
            for i in {1..10}; do
              if curl -s http://localhost:8080/health | grep -q "OK"; then
                echo "Rollback health check passed!"
                exit 0
              fi
              echo "Retrying health check ($i/10)..."
              sleep 5
            done
            echo "Rollback health check failed!"
            exit 1
