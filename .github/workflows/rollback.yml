name: Manual Rollback

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'The full commit SHA to roll back to'
        required: true

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Specific SHA to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/lattice

            # Login to registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull the specific image
            IMAGE_NAME="ghcr.io/${{ github.repository }}:${{ github.event.inputs.commit_sha }}"
            echo "Rolling back to image: $IMAGE_NAME"

            docker pull $IMAGE_NAME

            # Update docker-compose to use this specific image temporarily
            # or just tag it as latest
            docker tag $IMAGE_NAME ghcr.io/${{ github.repository }}:latest

            # Restart with the tagged 'latest' image
            docker compose up -d --remove-orphans

            # Wait for health check
            echo "Waiting for health check..."
            for i in {1..10}; do
              if curl -s http://localhost:8080/health | grep -q "OK"; then
                echo "Rollback health check passed!"
                exit 0
              fi
              echo "Retrying health check ($i/10)..."
              sleep 5
            done
            echo "Rollback health check failed!"
            exit 1
