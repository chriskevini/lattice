name: PR Body Check

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: read

jobs:
  pr-body-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Check PR body structure
        shell: bash
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking PR body for required sections..."
          
          # Check for required sections in correct order
          if [[ "$PR_BODY" != *"## Related"* ]]; then
            echo "❌ Missing required section: ## Related"
            echo "Please use the PR template and include all required sections."
            exit 1
          fi
          
          # Verify Related section contains "None"
          RELATED=$(echo "$PR_BODY" | sed -n '/## Related/,/## /p' | sed '$d' | tail -n +2)
          if [[ "$RELATED" != *"None"* ]]; then
            echo "❌ ## Related section must contain 'None' or a related issue reference"
            echo "   Found: '$RELATED'"
            exit 1
          fi
          
          # Check sections appear in order: Related → Summary → Changes → Impact
          if ! echo "$PR_BODY" | grep -qPz '## Related.*## Summary.*## Changes.*## Impact'; then
            echo "❌ Sections must be in order: ## Related, ## Summary, ## Changes, ## Impact"
            echo "   Please use the PR template."
            exit 1
          fi
          
          echo "✅ PR body structure is valid"
