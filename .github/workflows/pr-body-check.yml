name: PR Body Check

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: read

jobs:
  pr-body-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Check PR title and body structure
        shell: bash
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking PR title for conventional commits format..."
          
          # Validate PR title follows conventional commits format
          # Format: type: description or type(scope): description
          if ! [[ "$PR_TITLE" =~ ^[a-z]+(\([a-z]+\))?:\s.+ ]]; then
            echo "❌ PR title must follow conventional commits format: type: description or type(scope): description"
            echo "   Found: '$PR_TITLE'"
            echo "   Examples: 'feat: add new feature', 'fix(auth): resolve login bug'"
            exit 1
          fi
          
          echo "✅ PR title is valid"
          echo "Checking PR body for required sections..."
          
          # Check for required sections in correct order
          if [[ "$PR_BODY" != *"## Related"* ]]; then
            echo "❌ Missing required section: ## Related"
            echo "Please use the PR template and include all required sections."
            exit 1
          fi
          
          # Verify Related section contains "None"
          RELATED=$(echo "$PR_BODY" | sed -n '/## Related/,/## Summary/p' | tail -n +2)
          if [[ "$RELATED" != *"None"* ]]; then
            echo "❌ ## Related section must contain 'None' or a related issue reference"
            echo "   Found: '$RELATED'"
            exit 1
          fi
          
          if [[ "$PR_BODY" != *"## Summary"* ]]; then
            echo "❌ Missing required section: ## Summary"
            echo "Please use the PR template and include all required sections."
            exit 1
          fi
          
          if [[ "$PR_BODY" != *"## Changes"* ]]; then
            echo "❌ Missing required section: ## Changes"
            echo "Please use the PR template and include all required sections."
            exit 1
          fi
          
          if [[ "$PR_BODY" != *"## Impact"* ]]; then
            echo "❌ Missing required section: ## Impact"
            echo "Please use the PR template and include all required sections."
            exit 1
          fi
          
          # Check sections appear in order: Related → Summary → Changes → Impact
          if [[ "$PR_BODY" != *"## Related"*"## Summary"*"## Changes"*"## Impact"* ]]; then
            echo "❌ Sections must be in order: ## Related, ## Summary, ## Changes, ## Impact"
            echo "   Please use the PR template."
            exit 1
          fi
          
          echo "✅ PR body structure is valid"
